name: CI

on:
  push:
    branches:
      - 'feature/**'
  pull_request:
    branches: [ main, develop ]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Compose
        uses: docker/setup-buildx-action@v3

      - name: Run unit tests
        run: |
          docker compose -f docker-compose.prod.yml up --build --exit-code-from core-unit-tests

      - name: Upload unit test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: services/core/test-results/
          retention-days: 30

  # integration-tests:
  #   runs-on: ubuntu-latest
  #   needs: unit-tests
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Docker Compose
  #       uses: docker/setup-buildx-action@v3

  #     - name: Create .env file
  #       run: |
  #         echo "DB_USER=admin" >> .env
  #         echo "DB_PASSWORD=shared" >> .env
  #         echo "DB_NAME=core-postgres" >> .env
  #         echo "REDIS_PASSWORD=shared" >> .env
  #         echo "REDIS_PORT=6379" >> .env

  #     - name: Run integration tests
  #       run: |
  #         docker compose -f docker-compose.prod.yml up integration-tests --build --exit-code-from integration-tests

  #     - name: Upload integration test results
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: integration-test-results
  #         path: services/core/test-results/
  #         retention-days: 30

  # e2e-tests:
  #   runs-on: ubuntu-latest
  #   needs: integration-tests
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Docker Compose
  #       uses: docker/setup-buildx-action@v3

  #     - name: Create .env file
  #       run: |
  #         echo "DB_USER=test" >> .env
  #         echo "DB_PASSWORD=test" >> .env
  #         echo "DB_NAME=test" >> .env
  #         echo "REDIS_PASSWORD=test" >> .env
  #         echo "REDIS_PORT=6379" >> .env

  #     - name: Start application
  #       run: |
  #         docker compose -f docker-compose.prod.yml up core-app -d --build

  #     - name: Wait for application
  #       run: |
  #         sleep 30

  #     - name: Run e2e tests
  #       run: |
  #         docker compose -f docker-compose.prod.yml up e2e-tests --build --exit-code-from e2e-tests

  #     - name: Upload e2e test results
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: e2e-test-results
  #         path: services/e2e/test-results/
  #         retention-days: 30

  #     - name: Stop application
  #       if: always()
  #       run: |
  #         docker compose -f docker-compose.prod.yml down

  generate-allure-report:
    name: Generate and Publish Allure Report
    runs-on: ubuntu-latest
    needs: [unit-tests] #, integration-tests, e2e-tests]
    if: always()
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download all test results
        if: always()
        uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: Checkout gh-pages for history
        if: always()
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Install Allure
        if: always()
        run: |
          sudo apt-get update
          sudo apt-get install default-jre wget -y
          wget -q -O allure-2.27.0.tgz https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          sudo tar -zxvf allure-2.27.0.tgz -C /opt/
          sudo ln -sf /opt/allure-2.27.0/bin/allure /usr/bin/allure

      - name: Prepare results with history
        if: always()
        run: |
          mkdir -p combined-results
          find all-results -name "*.xml" -exec cp {} combined-results/ \;
          
          if [ -d "gh-pages/history" ]; then
            echo "Restoring history from gh-pages"
            mkdir -p combined-results/history
            cp -r gh-pages/history/* combined-results/history/
          fi

      - name: Generate Allure Report
        if: always()
        run: |
          allure generate combined-results -o allure-report --clean

      - name: Prepare gh-pages content
        if: always()
        run: |
          rm -rf gh-pages/*
          cp -r allure-report/* gh-pages/

      - name: Setup Git config
        if: always()
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: gh-pages
          force_orphan: false
          keep_files: false

      - name: Upload history for future runs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-history
          path: gh-pages/history
          retention-days: 30